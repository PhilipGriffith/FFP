<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>AHP 3</title>
		<script type="text/javascript" src="../static/d3/d3.v3.js"></script>
		<style type="text/css">
			path {
			        fill: lightgrey;
			     }
			circle {
			        opacity: 0.75;
			       }
		</style>
	</head>
	<body>
		<script type="text/javascript">

		    //DEMO VALUES
		    var wbid_value = 2;
		    var ag_value = 4;
		    var bio_value = 8;

		    //MongoDB URL
		    var mongodb = "http://localhost:5000/query="
		    var csv_data = "../static/data/ffp.csv"
		    var geojson_data = "../static/geojson/florida.json"

			//Width and height
			var width = 700;
			var height = 580;

			//Define map projection
			var projection = d3.geo.albers()
			                        .scale(4000)
			                        .rotate([83.5, -.6, 0])
			                        .center([0, 27])
			                        .translate([width/2, height/2]);

			//Define path generator
			var path = d3.geo.path()
							 .projection(projection);

			//Create SVG element
			var svg = d3.select("body")
			            .append("svg")
						.attr("width", width)
						.attr("height", height);

			//DEMO BUTTON
			svg.selectAll("button")
			    .data("Change!")
			    .enter()
			    .append("rect")
			    .attr("height", 20)
			    .attr("width", 20)
			    .attr("fill", "green")
			    .on("mouseover", function(d){
			            d3.select(this).attr("fill", "blue");
			    })
			    .on("mouseout", function(d){
			            d3.select(this).attr("fill", "green");
			    })
			    .on("click", function(d){
			            update_scores(wbid_value, ag_value, bio_value);
/*			            svg.selectAll("circle")
			                .transition()
			                .duration(500)
			                .attr("fill", "blue")
*/
			    });

			function update_scores(wbid, ag, bio){
			        //Set query URL
			        url = mongodb + wbid + "&" + ag + "&" + bio;

			        //Load data from MongoDB
			        d3.json(url, function(json){

			            //Load FFP data
			            d3.csv(csv_data, function(csv){

                            //Loop through once for each score in the json data
			                for (var i = 0; i < json.scores.length; i++){

			                    var json_id = json.scores[i].site_id;
			                    var score = json.scores[i].score;

			                    //Find the corresponding site in the csv data
			                    for (var j = 0; j < csv.length; j++){

			                        var csv_id = csv[j].SITE_ID;

			                        if (json_id == csv_id){

			                            csv[j].SCORE = score;
			                            break;
			                        }
			                    }
			                }
			                svg.selectAll("circle")
                                .data(csv)
                                .transition()
                                .duration(500)
                                .attr("r", 5)
                                .attr("fill", "orange");
			            });
			        });
			};

			//Load in GeoJSON data
			d3.json(geojson_data, function(json) {

				//Bind data and create one path per GeoJSON feature
				svg.selectAll("path")
				   .data(json.features)
				   .enter()
				   .append("path")
				   .attr("d", path);

                // Load FFP data
                d3.csv(csv_data, function(csv){

                    svg.selectAll("circle")
                        .data(csv)
                        .enter()
                        .append("circle")
                        .attr("cx", function(d){
                                return projection([d.LON, d.LAT])[0];
                        })
                        .attr("cy", function(d){
                                return projection([d.LON, d.LAT])[1];
                        })
                        .attr("r", 5)
                        .attr("fill", "red")
                        .on("click", function(d){
                                console.log(d.SCORE);
                                //window.open(d.URL);
                        });
                });
			});

		</script>
	</body>
</html>